version: '3.9'

x-x:
  LN_DB: &ln-db-user-pass "lightningd"
  DB_PASS: &db-user-pass "globalbitcoins"
  IDENTITY_DB: &identity-db "identity"
  TELEGRAM_DB: &telegram-db "telegram"
  DATA_DB: &data-db "data"
  BITCOIN_USER: &bitcoin-user "MyRpcUsername"
  BITCOIN_PASS: &bitcoin-pass "MyRpcPassword"
  BITCOIN_HOST: &bitcoin-host "btc-core"
  BITCOIN_PORT: &bitcoin-port "18334"

x-common-variables: &common-variables
  MIGRATE: "true"
  SMTP_SERVER: "mail"
  SMTP_PORT: "25"
  SMTP_USER: "support"
  SMTP_PASS: "Iate2aexaengai2e"
  SMTP_FROM: "support@test.transbithub.com"
  SITE_NAME: &site-name "test.transbithub.com"
  SITE_NAME_ONION: &site-name-onion "md5ytmyud45slls4li7crl7gudybjxz7lavd3bfaapm6ytdnun3wqvyd.onion"
  BACKEND_API: "http://backend:50050"
  LOG_LEVEL: "Debug"
  FLUENTD_HOST: "fluentd"
  FLUENTD_UDP_PORT: "20001"
  TELEGRAM_BOT_NAME: &telegram-bot-name "@transbithub_test_bot"
  DATA_HOST: "postgres-data"
  DATA_PORT: "5432"
  DATA_DB: *data-db
  DATA_USER: *db-user-pass
  DATA_PASS: *db-user-pass
  NATS_URL: "nats://nats:4222"
  AUTH_HOST: "auth"
  AUTH_HTTP_PORT: "5001"
  AUTH_HTTP2_PORT: "5002"
  AUTH_HOST_INTERNAL: "auth"
  AUTH_HTTP2_PORT_INTERNAL: "5002"
  REDIS_URL: "redis:6379"
  BTC_SERVICE_URL: "http://btc-service:50060"
  BITCOIN_NETWORK: &bitcoin-network "testnet"
  BITCOIN_NETWORK_SHORT: &bitcoin-network-short "test"
  TZ: "Etc/UTC"
  LND_URL: "lnd:10009"
  LND_CERT_PATH: "/lnd/tls.cert"
  LND_MACAROON_PATH: "/lnd/admin.macaroon"
  ENVIRONMENT: &environment "Debug"


x-common-postgres-variables: &common-postgres-variables
  POSTGRESQL_POSTGRES_PASSWORD: "Batman01"
  POSTGRESQL_REPLICATION_MODE: "master"
  POSTGRESQL_REPLICATION_USER: "repl_user"
  POSTGRESQL_REPLICATION_PASSWORD: "repl_password"
  ALLOW_EMPTY_PASSWORD: "no"
  TZ: "Etc/UTC"

services:
  postgres-identity:
    image: bitnami/postgresql:13-debian-10
    restart: always
    environment:
      <<: *common-postgres-variables
      POSTGRESQL_USERNAME: *db-user-pass
      POSTGRESQL_PASSWORD: *db-user-pass
      POSTGRESQL_DATABASE: *identity-db
    configs:
      - source: postgres-identity
        target: /bitnami/postgresql/conf/postgresql.conf
    volumes:
      - postgres_identity:/bitnami/postgresql
    ports:
      - "5432"

  postgres-telegram:
    image: bitnami/postgresql:13-debian-10
    restart: always
    environment:
      <<: *common-postgres-variables
      POSTGRESQL_USERNAME: *db-user-pass
      POSTGRESQL_PASSWORD: *db-user-pass
      POSTGRESQL_DATABASE: *telegram-db
    configs:
      - source: postgres-telegram
        target: /bitnami/postgresql/conf/postgresql.conf
    volumes:
      - postgres_telegram:/bitnami/postgresql
    ports:
      - "5432"

  postgres-telegram-notify:
    image: bitnami/postgresql:13-debian-10
    restart: always
    environment:
      <<: *common-postgres-variables
      POSTGRESQL_USERNAME: *db-user-pass
      POSTGRESQL_PASSWORD: *db-user-pass
      POSTGRESQL_DATABASE: *telegram-db
    configs:
      - source: postgres-telegram
        target: /bitnami/postgresql/conf/postgresql.conf
    volumes:
      - postgres_telegram_notify:/bitnami/postgresql
    ports:
      - "5432"

  postgres-data:
    image: bitnami/postgresql:13-debian-10
    restart: always
    environment:
      <<: *common-postgres-variables
      POSTGRESQL_USERNAME: *db-user-pass
      POSTGRESQL_PASSWORD: *db-user-pass
      POSTGRESQL_DATABASE: *data-db
    configs:
      - source: postgres-data
        target: /bitnami/postgresql/conf/postgresql.conf
    volumes:
      - postgres_data:/bitnami/postgresql
    ports:
      - "5432"


  mail:
    restart: always
    image: ${MASTER_MAIL_TAG}
    environment:
      TZ: "Etc/UTC"
    ports:
      - target: 25
        published: 125
        protocol: tcp
        mode: host
      - target: 143
        published: 1143
        protocol: tcp
        mode: host
    configs:
      - source: exim-master-conf
        target: /etc/exim4/exim.conf
      - source: dovecot-conf
        target: /etc/dovecot/dovecot.conf
      - source: dovecot-passwd
        target: /etc/dovecot/passwd
    volumes:
      - mail:/mail

  btc-core:
    restart: always
    image: ${BTC_CORE_TAG}
    stop_grace_period: 5m
    environment:
      BITCOIN_USER: *bitcoin-user
      BITCOIN_PASS: *bitcoin-pass
      BITCOIN_PORT: *bitcoin-port
      SITE_NAME_ONION: *site-name-onion
      BITCOIN_NETWORK_SHORT: *bitcoin-network-short
      TZ: "Etc/UTC"
    volumes:
      - btc_core:/opt/data
    ports:
      - "18333:8333"
      - *bitcoin-port
      - 28332
      - 28333
      - 28334
      - 28335

  lnd:
    restart: always
    image: ${LND_TAG}
    ports:
      - "19735:19735"
      - 10009
      - 10010
    environment:
      PORT: "19735"
      ALIAS: *site-name
      LND_PASSWORD: "Batman01"
      BTC_RPC_HOST: "btc-core:18334"
      BTC_RPC_USER: *bitcoin-user
      BTC_RPC_PASS: *bitcoin-pass
      BTC_ZMQ_RAW_BLOCKS: "btc-core:28334"
      BTC_ZMQ_RAW_TX: "btc-core:28335"
      TOR_PASSWORD: "Batman01"
      TESTNET: "yes"
      TOR_ENABLE: "yes"
    volumes:
      - lnd:/root/.lnd
      - btc_core:/bitcoin
      - ln_cli:/root/.lncli

  #password
  rtl:
    image: shahanafarooqui/rtl:0.10.1
    restart: unless-stopped
    depends_on:
      - lnd
    volumes:
      - lnd:/shared
    ports:
      - "8091:8090"
    environment:
      PORT: 8090
      HOST: "0.0.0.0"
      MACAROON_PATH: /shared
      LN_SERVER_URL: https://lnd:10010
      LN_IMPLEMENTATION: LND
      CONFIG_PATH: ''
      RTL_SSO: 0
      RTL_COOKIE_PATH: ''
      LOGOUT_REDIRECT_LINK: ''
      RTL_CONFIG_PATH: /RTL
      BITCOIND_CONFIG_PATH: ''
      CHANNEL_BACKUP_PATH: /backup

  nats:
    image: 'nats:latest'
    ports:
      - 4222
    environment:
      TZ: "Etc/UTC"
    restart: always

  redis:
    restart: always
    image: redis
    environment:
      TZ: "Etc/UTC"
    ports:
      - 6379


  auth:
    restart: always
    image: ${AUTH_TAG}
    stop_grace_period: 5m
    environment:
      IDENTITY_HOST: "postgres-identity"
      IDENTITY_PORT: "5432"
      IDENTITY_DB: *identity-db
      IDENTITY_USER: *db-user-pass
      IDENTITY_PASS: *db-user-pass
      <<: *common-variables
    deploy:
      endpoint_mode: dnsrr
    #    ports:
    #      - 5001
    #      - 5002
    depends_on:
      - postgres-identity
      - mail

  backend:
    restart: always
    image: ${BACKEND_TAG}
    stop_grace_period: 5m
    deploy:
      endpoint_mode: dnsrr
    volumes:
      - lnd:/lnd
    #    ports:
    #      - 50050
    #      - 50051
    #      - 50052
    #      - "1222:22"
    environment:
      DEBUG_BALANCES: "false"
      GPG_PUBLIC_KEY: "7013A4C4DE04DADF91ED1DA75E35A2BB0AD5B63A"
      <<: *common-variables
    configs:
      - source: test-keyring
        target: /opt/keyring.pgp
      - source: gpg-private-key
        target: /opt/private.pgp
    depends_on:
      - auth
      - btc-service
      - nats
      - postgres-data
      - redis
      - lnd

  crons:
    restart: always
    image: ${CRONS_TAG}
    stop_grace_period: 5m
    deploy:
      endpoint_mode: dnsrr
    volumes:
      - lnd:/lnd
    #    ports:
    #      - 50080
    environment:
      RATES_TOKEN: "bff092351f8bbbe8255cf862"
      RATES_DELAY_MINUTES: "60"
      PROXY_URL: "http://10.1.0.10:3128"
      GPG_PUBLIC_KEY: "7013A4C4DE04DADF91ED1DA75E35A2BB0AD5B63A"
      <<: *common-variables
    configs:
      - source: test-keyring
        target: /opt/keyring.pgp
      - source: gpg-private-key
        target: /opt/private.pgp
    depends_on:
      - btc-service
      - nats
      - postgres-data
      - mail
      - redis
      - lnd

  btc-service:
    restart: always
    image: ${BTC_SERVICE_TAG}
    stop_grace_period: 5m
    deploy:
      endpoint_mode: dnsrr
    #    ports:
    #      - 50060
    environment:
      <<: *common-variables
      BTC_URL: "http://btc-core:18334"
      BTC_USER: *bitcoin-user
      BTC_PASS: *bitcoin-pass
      DISABLE_BACKUPER: "false"
    volumes:
      - btc_core:/bitcoin
    depends_on:
      - btc-core
      - postgres-data

  telegram-service:
    restart: always
    image: ${TELEGRAM_SERVICE_TAG}
    stop_grace_period: 5m
    environment:
      <<: *common-variables
      LOG_LEVEL: "Debug"
      TELEGRAM_HOST: "postgres-telegram"
      TELEGRAM_PORT: "5432"
      TELEGRAM_DB: *telegram-db
      TELEGRAM_USER: *db-user-pass
      TELEGRAM_PASS: *db-user-pass
      TELEGRAM_TOKEN: "1637841750:AAFaeJKyPHXYXOUeeZ4T-QzmyTASr0Kj6b0"
      BACKEND_GRPC_URL: "https://envoy:9443"
      WEBHOOK_IP: *site-name
      WEBHOOK_PATH: "telegram"
      TELEGRAM_BOT_NAME: *telegram-bot-name
      TELEGRAM_BASE_URL: "http://envoy:1001/telegram"
    deploy:
      endpoint_mode: dnsrr
    #    ports:
    #      - "12222:22"
    #      - 50070
    #      - 50071
    depends_on:
      - postgres-telegram
      - envoy

  telegram-notify-service:
    restart: always
    image: ${TELEGRAM_NOTIFY_TAG}
    stop_grace_period: 5m
    environment:
      <<: *common-variables
      LOG_LEVEL: "Debug"
      TELEGRAM_HOST: "postgres-telegram-notify"
      TELEGRAM_PORT: "5432"
      TELEGRAM_DB: *telegram-db
      TELEGRAM_USER: *db-user-pass
      TELEGRAM_PASS: *db-user-pass
      TELEGRAM_TOKEN: "1652265226:AAHfVDZooXIiCV9VmkECRabzaHKBeBkbtTI"
      ##1700441894:AAEd6pz9dlDvXXSgwlTiGeHTDPZK9x9mVQ0
      BACKEND_GRPC_URL: "https://envoy:9443"
      WEBHOOK_IP: *site-name
      WEBHOOK_PATH: "telegram-notify"
      TELEGRAM_BOT_NAME: "@transbithub_notify_test_bot"
      TELEGRAM_BASE_URL: "http://envoy:1001/telegram"
    deploy:
      endpoint_mode: dnsrr
    #    ports:
    #      - "12222:22"
    #      - 50070
    #      - 50071
    depends_on:
      - postgres-telegram-notify
      - envoy

  adminka:
    restart: always
    image: ${ADMINKA_TAG}
    stop_grace_period: 5m
    deploy:
      endpoint_mode: dnsrr
    volumes:
      - lnd:/lnd
    environment:
      IDENTITY_HOST: "postgres-identity"
      IDENTITY_PORT: "5432"
      IDENTITY_DB: *identity-db
      IDENTITY_USER: *db-user-pass
      IDENTITY_PASS: *db-user-pass
      <<: *common-variables
    depends_on:
      - auth
      - nats
      - postgres-data
      - lnd

  cli:
    image: ${CLI_TAG}
    stop_grace_period: 5m
    environment:
      IDENTITY_HOST: "postgres-identity"
      IDENTITY_PORT: "5432"
      IDENTITY_DB: *identity-db
      IDENTITY_USER: *db-user-pass
      IDENTITY_PASS: *db-user-pass
      <<: *common-variables
    depends_on:
      - postgres-identity
      - postgres-data

  adminka-front:
    restart: always
    image: ${ADMINKA_FRONT_TAG}
    deploy:
      endpoint_mode: dnsrr
  #    ports:
  #      - 80

  envoy:
    restart: always
    image: ${ENVOY_TAG}
    extra_hosts:
      - "front-test:10.3.0.130"
      - "front-test:10.3.0.134"
      - "front-test:10.3.0.138"
      - "front-test:10.3.0.142"
      - "front-test:10.3.0.146"
      - "front-test:10.3.0.150"
      - "front-test:10.3.0.154"
      - "front-test:10.3.0.158"
      - "front-test:10.3.0.162"
      - "front-test:10.3.0.166"
      - "front-test:10.3.0.170"
      - "front-test:10.3.0.174"
      - "front-test:10.3.0.178"
      - "front-test:10.3.0.182"
      - "front-test:10.3.0.186"
      - "front-test:10.3.0.190"
      - "front-test:10.3.0.194"
      - "front-test:10.3.0.198"
      - "front-test:10.3.0.202"
      - "front-test:10.3.0.206"
      - "front-test:10.3.0.210"
      - "front-test:10.3.0.214"
      - "front-test:10.3.0.218"
      - "front-test:10.3.0.222"
      - "front-test:10.3.0.226"
      - "front-test:10.3.0.230"
      - "front-test:10.3.0.234"
      - "front-test:10.3.0.238"
      - "front-test:10.3.0.242"
      - "front-test:10.3.0.246"
      - "front-test:10.3.0.250"
    configs:
      - source: envoy-onion-yaml
        target: /etc/envoy/envoy.yaml
      - source: envoy-pem
        target: /etc/envoy/envoy.pem
      - source: envoy-key
        target: /etc/envoy/envoy.key
    environment:
      - "ENVOY_UID=0"
    ports:
      - "18080:8080"
      - "19000:9000"
      - 9443
      - "18081:18081"
      - "9902:9901"

  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_PASSWORD: "Batman01"
      PGADMIN_DEFAULT_EMAIL: "bugs@transbithub.com"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - "15050:80"
    restart: always

  roundcube:
    image: instrumentisto/roundcube:fpm
    ports:
      - "9000"
    volumes:
      - roundcube:/app
    configs:
      - source: roundcube-config
        target: /app/config/config.inc.php
  roundcube-nginx:
    image: nginx:stable-alpine
    depends_on:
      - roundcube
    ports:
      - "80"
    volumes:
      - roundcube:/var/www
    configs:
      - source: roundcube-nginx-config
        target: /etc/nginx/conf.d/default.conf

configs:
  roundcube-nginx-config:
    file: ./Roundcube/fpm.nginx.conf
  roundcube-config:
    file: ./Roundcube/roundcube.config.php.test
  postgres-identity:
    file: ./postgres/postgresql-identity-backup.conf
  postgres-telegram:
    file: ./postgres/postgresql-telegram-backup.conf
  postgres-data:
    file: ./postgres/postgresql-data-backup.conf
  exim-master-conf:
    file: ./mail/exim-master.conf
  dovecot-conf:
    file: ./mail/dovecot.conf
  dovecot-passwd:
    file: ./mail/dovecot_passwd
  envoy-onion-yaml:
    file: ./envoy/envoy.onion.yaml
  envoy-pem:
    file: ./envoy/envoy.pem
  envoy-key:
    file: ./envoy/envoy.key
  test-keyring:
    file: ./test.keyring
  gpg-private-key:
    file: ./private.pgp

volumes:
  btc_core:
  watchtower:
  postgres_identity:
  postgres_data:
  postgres_telegram:
  postgres_ln:
  jiraVolume:
  mail:
  ln_home:
  lnd:
  lnd_admin:
  pgadmin_data:
  roundcube:
  postgres_telegram_notify:
  ln_cli:
