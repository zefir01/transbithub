INTERNAL_SERVER             = 10.1.0.9
domainlist local_domains    = transbithub.com
primary_hostname            = mail.transbithub.com
hostlist   relay_from_hosts = 127.0.0.1 : 172.18.0.0/16 : INTERNAL_SERVER
qualify_domain              = transbithub.com

DKIM_DOMAIN                     = transbithub.com
DKIM_FILE                       = /etc/exim4/transbithub.com.public
DKIM_PRIVATE_KEY                = /etc/exim4/transbithub.com.key
DKIM_SELECTOR                   = email  

acl_smtp_rcpt                   = acl_check_rcpt
acl_smtp_data_prdr              = acl_check_prdr
acl_smtp_data                   = acl_check_data
acl_smtp_dkim                   = acl_check_dkim

never_users = root
host_lookup = *
dns_dnssec_ok = 1
rfc1413_hosts = *
rfc1413_query_timeout = 0s
ignore_bounce_errors_after = 30m
freeze_tell = postmaster
auto_thaw = 1h
message_size_limit = 16M
smtp_accept_max = 50
smtp_accept_max_per_connection = 50
smtp_connect_backlog = 50
smtp_accept_max_per_host = 25
split_spool_directory = true
remote_max_parallel = 15
disable_ipv6=true
#dns_ipv4_lookup='*'
daemon_smtp_ports = 25 : 465 : 587
tls_on_connect_ports = 465

log_selector = \
        +all_parents \
        +lost_incoming_connection \
        +received_sender \
        +received_recipients \
        +smtp_confirmation \
        +smtp_syntax_error \
        +smtp_protocol_error \
        -queue_run
timeout_frozen_after = 7d



begin acl

acl_check_rcpt:
  accept  hosts         = +relay_from_hosts
          control       = dkim_disable_verify

  deny    message       = HELO/EHLO required by SMTP RFC
          condition     = ${if eq{$sender_helo_name}{}{yes}{no}}
  deny    message       = Go Away! You are spammer.
          condition     = ${if match{$sender_host_name} \
                           {bezeqint\\.net|net\\.il|dialup|pool|peer|dhcp} \
                           {yes}{no}}
  deny    message       = host is listed in $dnslist_domain
          dnslists      = sbl.spamhaus.org : \
                          relays.ordb.org : \
                          opm.blitzed.org : \
                          proxies.blackholes.easynet.nl  

  defer set acl_m_spf = ${run{/usr/bin/spfquery \
                        -ip "$sender_host_address" \
                        -sender "$sender_address" \
                        -helo "$sender_helo_name"}{}{}}
        set acl_m_spf = $runrc
        logwrite      = ++ spf=$acl_m_spf \
                        ip=$sender_host_address \
                        sender=$sender_address \
                        helo=$sender_helo_name
        message       = SPF record for $sender_address \
                        cannot be verified at the moment
        condition     = ${if ={$acl_m_spf}{6}}
  
  deny  message       = SPF policy prohibits sending from \
                        address $sender_host_address
        condition     = ${if ={$acl_m_spf}{3}}

  accept  domains       = +local_domains
          endpass
          message       = unknown user
          verify        = recipient
  deny    message       = RELAY NOT PERMITTED

acl_check_prdr:
  warn  set acl_m_did_prdr = y
  accept

acl_check_data:
  deny    !verify =     header_syntax
          message =     header syntax
	  !authenticated = *
          log_message = header syntax ()
  accept


acl_check_dkim:
      # Deny failures
      deny dkim_status = fail
           logwrite = DKIM test failed: 
           add_header = X-DKIM: DKIM test failed: (address= domain=), signature is bad.

      # Deny invalid signatures
      deny dkim_status = invalid
           add_header = X-DKIM:  (); 
           logwrite = DKIM test passed (address= domain=), but signature is invalid.

      # Accept valid/passed sigs
      accept dkim_status = pass
             logwrite = DKIM test passed
             add_header = X-DKIM: DKIM passed: (address= domain=), signature is good.


      # And anything else.
      accept


begin routers
internal:
  driver = manualroute
  domains = +local_domains
  transport = remote_smtp
  route_list = * INTERNAL_SERVER
  no_more
external:
  driver = dnslookup
  domains = ! +local_domains
  transport = remote_smtp
  ignore_target_hosts = 0.0.0.0 : 127.0.0.0/8
  no_more

begin transports
remote_smtp:
  driver = smtp
  dkim_domain           = DKIM_DOMAIN
  dkim_selector         = DKIM_SELECTOR
  dkim_private_key      = DKIM_PRIVATE_KEY


begin retry
transbithub.com        *           F,10m,10m; G,16h,1h,1.5; F,4d,6h
*                      *           F,2h,15m; G,16h,1h,1.5; F,4d,6h
begin rewrite

begin authenticators


